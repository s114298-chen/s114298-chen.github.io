<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人記帳本 - 網頁版</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --main-color: #5c8ab3; /* 柔和灰藍色，不刺眼 */
            --main-bg: #f5f7f9;
            --income-color: #2ecc71;
            --expense-color: #e74c3c;
        }

        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: var(--main-bg); color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* 登入介面 - 強化顯示層級 */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #2c3e50; display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .auth-box { background: white; padding: 40px; border-radius: 15px; width: 320px; text-align: center; }
        
        /* 記帳區 - 預設隱藏 */
        #app-content { display: none; }

        h1, h2 { color: var(--main-color); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        form { display: flex; flex-direction: column; gap: 12px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; }
        button { background: var(--main-color); color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { opacity: 0.9; }

        /* 第四點：結算卡片 */
        .summary-card {
            background: #fff; border: 2px solid var(--main-color); padding: 20px; border-radius: 10px;
            display: flex; justify-content: space-around; align-items: center; margin: 20px 0;
        }
        .summary-item { text-align: center; }
        .summary-item label { display: block; font-size: 14px; color: #777; }
        .summary-item span { font-size: 24px; font-weight: bold; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; }
        .income-val { color: var(--income-color); font-weight: bold; }
        .expense-val { color: var(--expense-color); font-weight: bold; }
        
        #logout-btn { background: #95a5a6; float: right; padding: 8px 15px; font-size: 13px; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-box">
            <h2 style="margin-top:0">帳號登入 / 註冊</h2>
            <form id="authForm">
                <input type="text" id="username" placeholder="請輸入帳號" required>
                <input type="password" id="password" placeholder="請輸入密碼" required>
                <button type="submit">確認進入系統</button>
            </form>
            <p id="auth-msg" style="color:red; font-size:14px; margin-top:10px"></p>
        </div>
    </div>

    <div class="container" id="app-container">
        <button id="logout-btn">登出</button>
        <h1 style="margin-top:0">雲端個人帳本</h1>

        <div id="app-content">
            <div class="grid">
                <div>
                    <h2>1. 新增交易紀錄</h2>
                    <form id="transForm">
                        <select id="type">
                            <option value="支出">支出</option>
                            <option value="收入">收入</option>
                        </select>
                        <input type="number" id="amt" placeholder="金額" required>
                        <input type="date" id="date" required>
                        <select id="cat"></select>
                        <input type="text" id="note" placeholder="備註 (選填)">
                        <button type="submit">紀錄交易</button>
                    </form>

                    <h2>3. 設定當月預算</h2>
                    <form id="budgetForm">
                        <select id="budgetCat"></select>
                        <input type="number" id="budgetAmt" placeholder="設定上限金額" required>
                        <button type="submit" style="background:#7f8c8d">儲存預算設定</button>
                    </form>
                </div>

                <div>
                    <h2>2. 當月分析 (薪資/預算扣除)</h2>
                    <p>統計月份：<span id="curMonthText" style="font-weight:bold"></span></p>
                    <table id="analysisTable">
                        <thead><tr><th>類別</th><th>預算</th><th>實支</th><th>預算剩餘</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <div style="height:200px; margin-top:20px"><canvas id="myChart"></canvas></div>
                </div>
            </div>

            <h2>4. 當月財務結算</h2>
            <div class="summary-card">
                <div class="summary-item">
                    <label>當月總收入 (薪水+投資)</label>
                    <span id="total-in" class="income-val">0</span>
                </div>
                <div style="font-size:30px; color:#ddd">|</div>
                <div class="summary-item">
                    <label>當月總支出</label>
                    <span id="total-out" class="expense-val">0</span>
                </div>
                <div style="font-size:30px; color:#ddd">|</div>
                <div class="summary-item">
                    <label>本月結餘 (存款餘額)</label>
                    <span id="total-bal" style="color:var(--main-color)">0</span>
                </div>
            </div>

            <h2>歷史紀錄 (全部顯示)</h2>
            <table id="historyTable">
                <thead><tr><th>日期</th><th>類型</th><th>類別</th><th>金額</th><th>備註</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const STORE_KEY = 'LEDGER_FINAL_DATA';
        const EX_CATS = ['餐飲', '交通', '住房', '娛樂', '購物', '其他'];
        const IN_CATS = ['薪水', '投資'];
        let currentUser = null;
        let chartObj = null;

        // --- 登入控制 (修復重點) ---
        document.getElementById('authForm').onsubmit = function(e) {
            e.preventDefault();
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value;
            const users = JSON.parse(localStorage.getItem(STORE_KEY) || '{}');

            if (users[u]) {
                if (users[u].password === p) {
                    currentUser = u;
                    doLogin();
                } else {
                    document.getElementById('auth-msg').textContent = '密碼錯誤！';
                }
            } else {
                users[u] = { password: p, data: { trans: [], budget: {} } };
                localStorage.setItem(STORE_KEY, JSON.stringify(users));
                currentUser = u;
                doLogin();
                alert('帳號已註冊並登入');
            }
        };

        function doLogin() {
            // 雙重保險切換
            document.getElementById('auth-overlay').setAttribute('style', 'display:none !important');
            document.getElementById('app-content').style.display = 'block';
            initUI();
        }

        document.getElementById('logout-btn').onclick = () => location.reload();

        // --- 資料操作 ---
        function getMyData() {
            const users = JSON.parse(localStorage.getItem(STORE_KEY));
            return users[currentUser].data;
        }

        function saveMyData(d) {
            const users = JSON.parse(localStorage.getItem(STORE_KEY));
            users[currentUser].data = d;
            localStorage.setItem(STORE_KEY, JSON.stringify(users));
        }

        function initUI() {
            document.getElementById('date').value = new Date().toISOString().substring(0, 10);
            document.getElementById('cat').innerHTML = [...EX_CATS, ...IN_CATS].map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('budgetCat').innerHTML = EX_CATS.map(c => `<option value="${c}">${c}</option>`).join('');
            refresh();
        }

        document.getElementById('transForm').onsubmit = function(e) {
            e.preventDefault();
            const d = getMyData();
            const date = document.getElementById('date').value;
            d.trans.push({
                type: document.getElementById('type').value,
                amt: parseInt(document.getElementById('amt').value),
                date: date,
                cat: document.getElementById('cat').value,
                note: document.getElementById('note').value,
                m: date.substring(0, 7)
            });
            saveMyData(d);
            document.getElementById('amt').value = '';
            document.getElementById('note').value = '';
            refresh();
        };

        document.getElementById('budgetForm').onsubmit = function(e) {
            e.preventDefault();
            const d = getMyData();
            const m = new Date().toISOString().substring(0, 7);
            const c = document.getElementById('budgetCat').value;
            if(!d.budget[m]) d.budget[m] = {};
            d.budget[m][c] = parseInt(document.getElementById('budgetAmt').value);
            saveMyData(d);
            alert(c + ' 預算設定成功');
            refresh();
        };

        function refresh() {
            const d = getMyData();
            const m = new Date().toISOString().substring(0, 7);
            document.getElementById('curMonthText').textContent = m;

            let tin = 0, tout = 0;
            const spent = {};
            EX_CATS.forEach(c => spent[c] = 0);

            // 計算當月
            d.trans.filter(t => t.m === m).forEach(t => {
                if(t.type === '收入') tin += t.amt;
                else { tout += t.amt; if(spent.hasOwnProperty(t.cat)) spent[t.cat] += t.amt; }
            });

            // 更新結算
            document.getElementById('total-in').textContent = tin.toLocaleString();
            document.getElementById('total-out').textContent = tout.toLocaleString();
            document.getElementById('total-bal').textContent = (tin - tout).toLocaleString();

            // 更新預算表
            const b = d.budget[m] || {};
            const tbody = document.querySelector('#analysisTable tbody');
            tbody.innerHTML = '';
            EX_CATS.forEach(c => {
                if(b[c] || spent[c] > 0) {
                    const row = tbody.insertRow();
                    const rem = (b[c] || 0) - spent[c];
                    row.innerHTML = `<td>${c}</td><td>${(b[c]||0).toLocaleString()}</td><td>${spent[c].toLocaleString()}</td><td class="${rem<0?'expense-val':''}">${rem.toLocaleString()}</td>`;
                }
            });

            // 更新歷史 (不限筆數)
            const hBody = document.querySelector('#historyTable tbody');
            hBody.innerHTML = '';
            [...d.trans].reverse().forEach(t => {
                const row = hBody.insertRow();
                row.innerHTML = `<td>${t.date}</td><td class="${t.type==='收入'?'income-val':'expense-val'}">${t.type}</td><td>${t.cat}</td><td>${t.amt.toLocaleString()}</td><td style="color:#888;font-size:12px">${t.note}</td>`;
            });

            // 更新圖表
            const ctx = document.getElementById('myChart').getContext('2d');
            if(chartObj) chartObj.destroy();
            chartObj = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: EX_CATS,
                    datasets: [
                        { label: '實支', data: EX_CATS.map(c => spent[c]), backgroundColor: '#5c8ab3' },
                        { label: '預算', data: EX_CATS.map(c => b[c] || 0), backgroundColor: '#d5dbdb' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>
