<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººé›²ç«¯å¸³æœ¬ - æ°¸ä¹…å­˜å„²ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --main-color: #5c8ab3;
            --main-bg: #f5f7f9;
            --income-color: #2ecc71;
            --expense-color: #e74c3c;
        }

        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: var(--main-bg); color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #2c3e50; display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .auth-box { background: white; padding: 40px; border-radius: 15px; width: 320px; text-align: center; }
        #app-content { display: none; }

        h1, h2 { color: var(--main-color); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        form { display: flex; flex-direction: column; gap: 12px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; }
        button { background: var(--main-color); color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
        
        .month-nav {
            background: #eef2f6; padding: 15px; border-radius: 8px; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: center; gap: 15px;
        }
        .month-nav label { font-weight: bold; color: var(--main-color); }
        #viewMonthSelect { border: 2px solid var(--main-color); font-weight: bold; color: var(--main-color); padding: 5px 10px; }

        .summary-card {
            background: #fff; border: 2px solid var(--main-color); padding: 20px; border-radius: 10px;
            display: flex; justify-content: space-around; align-items: center; margin: 20px 0;
        }
        .summary-item { text-align: center; }
        .summary-item label { display: block; font-size: 13px; color: #777; }
        .summary-item span { font-size: 24px; font-weight: bold; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; }
        .income-val { color: var(--income-color); font-weight: bold; }
        .expense-val { color: var(--expense-color); font-weight: bold; }
        
        #logout-btn { background: #95a5a6; float: right; padding: 8px 15px; font-size: 13px; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-box">
            <h2 style="margin-top:0">è²¡å‹™ç³»çµ±ç™»å…¥</h2>
            <form id="authForm">
                <input type="text" id="username" placeholder="å¸³è™Ÿ" required>
                <input type="password" id="password" placeholder="å¯†ç¢¼" required>
                <button type="submit">ç¢ºèªé€²å…¥ç³»çµ±</button>
            </form>
            <p id="auth-msg" style="color:red; font-size:14px; margin-top:10px"></p>
        </div>
    </div>

    <div class="container">
        <button id="logout-btn">ç™»å‡ºç³»çµ±</button>
        <h1 style="margin-top:0">é›²ç«¯å€‹äººå¸³æœ¬</h1>

        <div id="app-content">
            <div class="month-nav">
                <label>ğŸ“… åˆ‡æ›æŸ¥çœ‹æœˆä»½ï¼š</label>
                <input type="month" id="viewMonthSelect">
            </div>

            <div class="grid">
                <div>
                    <h2>1. æ–°å¢äº¤æ˜“</h2>
                    <form id="transForm">
                        <select id="type">
                            <option value="æ”¯å‡º">æ”¯å‡º</option>
                            <option value="æ”¶å…¥">æ”¶å…¥</option>
                        </select>
                        <input type="number" id="amt" placeholder="é‡‘é¡" required>
                        <input type="date" id="date" required>
                        <select id="cat"></select>
                        <input type="text" id="note" placeholder="å‚™è¨»">
                        <button type="submit">ç´€éŒ„äº¤æ˜“</button>
                    </form>

                    <h2>3. è¨­å®šé¡åˆ¥é ç®—</h2>
                    <form id="budgetForm">
                        <select id="budgetCat"></select>
                        <input type="number" id="budgetAmt" placeholder="æœ¬æœˆé ç®—ä¸Šé™" required>
                        <button type="submit" style="background:#7f8c8d">å„²å­˜é ç®—</button>
                    </form>
                </div>

                <div>
                    <h2>2. <span id="displayMonthLabel"></span> é ç®—åˆ†æ</h2>
                    <table id="analysisTable">
                        <thead><tr><th>é¡åˆ¥</th><th>é ç®—</th><th>å¯¦æ”¯</th><th>çµé¤˜</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <div style="height:220px; margin-top:20px"><canvas id="myChart"></canvas></div>
                </div>
            </div>

            <h2>4. <span id="displayMonthLabel2"></span> è²¡å‹™çµç®—</h2>
            <div class="summary-card">
                <div class="summary-item">
                    <label>ç•¶æœˆç¸½æ”¶å…¥</label>
                    <span id="total-in" class="income-val">0</span>
                </div>
                <div style="font-size:30px; color:#ddd">|</div>
                <div class="summary-item">
                    <label>ç•¶æœˆç¸½æ”¯å‡º</label>
                    <span id="total-out" class="expense-val">0</span>
                </div>
                <div style="font-size:30px; color:#ddd">|</div>
                <div class="summary-item">
                    <label>æœ¬æœˆå‰©é¤˜ (çµé¤˜)</label>
                    <span id="total-bal" style="color:var(--main-color)">0</span>
                </div>
            </div>

            <h2>5. <span id="displayMonthLabel3"></span> äº¤æ˜“ç´€éŒ„æ¸…å–®</h2>
            <table id="historyTable">
                <thead><tr><th>æ—¥æœŸ</th><th>é¡å‹</th><th>é¡åˆ¥</th><th>é‡‘é¡</th><th>å‚™è¨»</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const STORE_KEY = 'LEDGER_MAIN_VAULT'; // ä½¿ç”¨å…¨æ–°çš„ç©©å®šé‡‘é‘°ï¼Œç¢ºä¿ä¸è¢«èˆŠç‰ˆæœ¬å¹²æ“¾
        const EX_CATS = ['é¤é£²', 'äº¤é€š', 'ä½æˆ¿', 'å¨›æ¨‚', 'è³¼ç‰©', 'å…¶ä»–'];
        const IN_CATS = ['è–ªæ°´', 'æŠ•è³‡'];
        let currentUser = null;
        let chartObj = null;

        // --- æ ¸å¿ƒå®‰å…¨å­˜å–å‡½æ•¸ ---
        function getAllUsers() {
            try {
                return JSON.parse(localStorage.getItem(STORE_KEY)) || {};
            } catch (e) {
                console.error("è³‡æ–™è®€å–å¤±æ•—ï¼Œé‡å»ºä¸­...");
                return {};
            }
        }

        function getMyData() {
            const users = getAllUsers();
            return users[currentUser] ? users[currentUser].data : { trans: [], budget: {} };
        }

        function saveMyData(newData) {
            const users = getAllUsers();
            if (!users[currentUser]) return;
            users[currentUser].data = newData;
            localStorage.setItem(STORE_KEY, JSON.stringify(users));
        }

        // --- ç™»å…¥èˆ‡åˆå§‹åŒ– ---
        document.getElementById('authForm').onsubmit = function(e) {
            e.preventDefault();
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value;
            const users = getAllUsers();

            if (users[u]) {
                if (users[u].password === p) {
                    currentUser = u;
                    doLogin();
                } else { document.getElementById('auth-msg').textContent = 'å¯†ç¢¼éŒ¯èª¤ï¼'; }
            } else {
                users[u] = { password: p, data: { trans: [], budget: {} } };
                localStorage.setItem(STORE_KEY, JSON.stringify(users));
                currentUser = u;
                doLogin();
            }
        };

        function doLogin() {
            document.getElementById('auth-overlay').setAttribute('style', 'display:none !important');
            document.getElementById('app-content').style.display = 'block';
            initUI();
        }

        document.getElementById('logout-btn').onclick = () => location.reload();

        function initUI() {
            const now = new Date();
            const curMonth = now.toISOString().substring(0, 7);
            document.getElementById('viewMonthSelect').value = curMonth;
            document.getElementById('date').value = now.toISOString().substring(0, 10);
            document.getElementById('cat').innerHTML = [...EX_CATS, ...IN_CATS].map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('budgetCat').innerHTML = EX_CATS.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('viewMonthSelect').onchange = refresh;
            refresh();
        }

        // --- æ–°å¢ç´€éŒ„ (ä¿®æ­£å­˜æª”é‚è¼¯) ---
        document.getElementById('transForm').onsubmit = function(e) {
            e.preventDefault();
            
            // æ¯æ¬¡å„²å­˜å‰ã€Œé‡æ–°æŠ“å–ã€è³‡æ–™åº«ï¼Œé˜²æ­¢è¦†è“‹
            const d = getMyData();
            const dateInput = document.getElementById('date').value;
            
            d.trans.push({
                type: document.getElementById('type').value,
                amt: parseInt(document.getElementById('amt').value) || 0,
                date: dateInput,
                cat: document.getElementById('cat').value,
                note: document.getElementById('note').value,
                m: dateInput.substring(0, 7)
            });
            
            saveMyData(d); // ç«‹å³å¯«å…¥ç¡¬ç¢Ÿ
            
            document.getElementById('amt').value = '';
            document.getElementById('note').value = '';
            refresh();
        };

        document.getElementById('budgetForm').onsubmit = function(e) {
            e.preventDefault();
            const d = getMyData();
            const m = document.getElementById('viewMonthSelect').value;
            const c = document.getElementById('budgetCat').value;
            if(!d.budget[m]) d.budget[m] = {};
            d.budget[m][c] = parseInt(document.getElementById('budgetAmt').value) || 0;
            saveMyData(d);
            alert('é ç®—å·²å„²å­˜');
            refresh();
        };

        function refresh() {
            const d = getMyData();
            const m = document.getElementById('viewMonthSelect').value;
            
            document.querySelectorAll('[id^="displayMonthLabel"]').forEach(el => el.textContent = m);

            let tin = 0, tout = 0;
            const spent = {};
            EX_CATS.forEach(c => spent[c] = 0);

            const filteredTrans = d.trans.filter(t => t.m === m);
            filteredTrans.forEach(t => {
                if(t.type === 'æ”¶å…¥') tin += t.amt;
                else { tout += t.amt; if(spent.hasOwnProperty(t.cat)) spent[t.cat] += t.amt; }
            });

            document.getElementById('total-in').textContent = tin.toLocaleString();
            document.getElementById('total-out').textContent = tout.toLocaleString();
            document.getElementById('total-bal').textContent = (tin - tout).toLocaleString();

            const b = d.budget[m] || {};
            const tbody = document.querySelector('#analysisTable tbody');
            tbody.innerHTML = '';
            EX_CATS.forEach(c => {
                if(b[c] || spent[c] > 0) {
                    const row = tbody.insertRow();
                    const rem = (b[c] || 0) - spent[c];
                    row.innerHTML = `<td>${c}</td><td>${(b[c]||0).toLocaleString()}</td><td>${spent[c].toLocaleString()}</td><td class="${rem<0?'expense-val':''}">${rem.toLocaleString()}</td>`;
                }
            });

            const hBody = document.querySelector('#historyTable tbody');
            hBody.innerHTML = '';
            [...filteredTrans].sort((a,b)=>b.date.localeCompare(a.date)).forEach(t => {
                const row = hBody.insertRow();
                row.innerHTML = `<td>${t.date}</td><td class="${t.type==='æ”¶å…¥'?'income-val':'expense-val'}">${t.type}</td><td>${t.cat}</td><td>${t.amt.toLocaleString()}</td><td style="color:#888;font-size:12px">${t.note}</td>`;
            });

            const ctx = document.getElementById('myChart').getContext('2d');
            if(chartObj) chartObj.destroy();
            chartObj = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: EX_CATS,
                    datasets: [
                        { label: 'å¯¦æ”¯', data: EX_CATS.map(c => spent[c]), backgroundColor: '#5c8ab3' },
                        { label: 'é ç®—', data: EX_CATS.map(c => b[c] || 0), backgroundColor: '#d5dbdb' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>
